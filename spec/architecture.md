# アプリケーションアーキテクチャ

このドキュメントでは、React Authentication Sample Appのアーキテクチャ設計について説明します。このアプリケーションは、モダンなReactアプリケーションの設計原則と、セキュアな認証システムの実装ベストプラクティスに基づいて構築されています。

## 全体構造

アプリケーションは以下の主要なレイヤーで構成されています：

```
+---------------------+
|     UI Layer        |
| (React Components)  |
+---------------------+
           |
+---------------------+
|   Application Layer |
| (Context, Hooks)    |
+---------------------+
           |
+---------------------+
|    Domain Layer     |
| (Logic, Models)     |
+---------------------+
           |
+---------------------+
|  Infrastructure     |
| (API, Storage)      |
+---------------------+
```

## 主要コンポーネント

### 1. UI Layer

UI Layerは、ユーザーインターフェース要素を構成するReactコンポーネントで構成されています。

#### 1.1 ページコンポーネント

- `LoginPage`: ユーザー認証フォームを提供
- `RegisterPage`: 新規ユーザー登録フォーム
- `DashboardPage`: 認証済みユーザー向けのメインダッシュボード
- `ProfilePage`: ユーザープロファイル管理
- `PasswordResetPage`: パスワードリセット機能

#### 1.2 共通コンポーネント

- `AuthForm`: 認証関連フォームの基本コンポーネント
- `ProtectedRoute`: 認証が必要なルートを保護するラッパーコンポーネント
- `SocialLoginButtons`: ソーシャルログイン用ボタングループ
- `LoadingSpinner`: API通信中などに表示するローディング表示
- `ErrorMessage`: エラー表示用コンポーネント

### 2. Application Layer

Application Layerは、UIとドメインロジックを接続し、状態管理を担当します。

#### 2.1 Context

- `AuthContext`: 認証状態とユーザー情報の管理
- `NotificationContext`: 通知とアラートの管理

#### 2.2 Custom Hooks

- `useAuth`: 認証コンテキストを使いやすいインターフェースで提供
- `useLoginForm`: ログインフォームのバリデーションと送信ロジック
- `useRegisterForm`: 登録フォームのバリデーションと送信ロジック
- `useProtectedFetch`: 認証済みAPI呼び出しを行うためのフック
- `useTokenRefresh`: トークン自動更新ロジック

### 3. Domain Layer

Domain Layerは、アプリケーションのビジネスロジックとデータ変換を担当します。

#### 3.1 Models

- `User`: ユーザー情報のモデル
- `AuthToken`: トークン管理モデル
- `ValidationRules`: 入力検証ルール

#### 3.2 Services

- `authService`: 認証関連のビジネスロジック
- `userService`: ユーザー情報管理ロジック
- `validationService`: 入力検証ロジック

### 4. Infrastructure Layer

Infrastructure Layerは、外部システムとの連携を担当します。

#### 4.1 API

- `apiClient`: Axiosベースの基本APIクライアント
- `authApi`: 認証関連APIエンドポイント
- `userApi`: ユーザー関連APIエンドポイント

#### 4.2 Storage

- `tokenStorage`: トークンの保存と取得
- `userStorage`: ユーザー情報のローカルキャッシュ

## 認証アーキテクチャ

### トークン管理

このアプリケーションはJWTベースの認証を使用しており、以下の2種類のトークンを管理します：

1. **アクセストークン**: API呼び出しの認証に使用される短寿命トークン
2. **リフレッシュトークン**: アクセストークンの更新に使用される長寿命トークン

トークンの保存場所は環境設定によって以下のいずれかを選択できます：

- `localStorage`: 開発環境向け（デフォルト）
- `httpOnly Cookie`: 本番環境向け（より安全）

### 認証フローのアーキテクチャ

認証フローは以下のコンポーネントで構成されています：

```
+----------------+      +----------------+      +-----------------+
|                |      |                |      |                 |
|  Login Form    +----->+  Auth Context  +----->+  Token Storage  |
|                |      |                |      |                 |
+----------------+      +-------+--------+      +-----------------+
                               |
                               v
                        +------+-------+
                        |              |
                        |   Auth API   |
                        |              |
                        +--------------+
```

1. ユーザーが認証情報を `LoginForm` で入力
2. `AuthContext` が情報を受け取り、`authApi` を通じてバックエンドにリクエスト
3. 認証成功時、`tokenStorage` にトークンを保存
4. `AuthContext` が認証状態を更新し、アプリケーション全体に通知

### 保護されたルート

認証が必要なルートは `ProtectedRoute` コンポーネントでラップされ、以下のロジックで保護されています：

```
+-----------------+     +-----------------+     +------------------+
|                 |     |                 |     |                  |
| Route Request   +---->+ Auth Check      +---->+ Protected Route  |
|                 |     |                 |     |                  |
+-----------------+     +--------+--------+     +------------------+
                                |
                                | If not authenticated
                                v
                         +------+-------+
                         |              |
                         | Redirect to  |
                         | Login Page   |
                         |              |
                         +--------------+
```

## 状態管理

アプリケーションの状態管理は、以下の原則に基づいています：

1. **認証状態**: `AuthContext` を使用して、アプリケーション全体で認証状態を管理
2. **UI状態**: コンポーネントローカルステートを使用して、UI関連の状態を管理
3. **APIデータ**: React Queryを使用して、APIデータのキャッシュとフェッチングを管理

## エラー処理

エラー処理は以下の層で行われます：

1. **API層**: API呼び出しのエラーをキャッチし、統一されたエラーオブジェクトに変換
2. **ドメイン層**: ビジネスロジックに関連するエラーを処理
3. **UI層**: エラーメッセージをユーザーフレンドリーな形式で表示

特に重要なのは、認証エラー（401）の処理で、以下のフローに従います：

```
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
| API 401 Error  +---->+ Token Refresh  +---->+ Retry Request |
|                |     |                |     |                |
+----------------+     +-------+--------+     +----------------+
                              |
                              | If refresh fails
                              v
                       +------+-------+
                       |              |
                       | Redirect to  |
                       | Login Page   |
                       |              |
                       +--------------+
```

## セキュリティ対策

このアプリケーションには、以下のセキュリティ対策が実装されています：

1. **XSS対策**:
   - ReactのJSX記法による自動エスケープ
   - Content Security Policy (CSP) の適用

2. **CSRF対策**:
   - HttpOnly Cookie使用時のCSRFトークン実装
   - SameSite Cookie属性の使用

3. **トークンセキュリティ**:
   - 短寿命アクセストークン（15分）
   - トークンリフレッシュ戦略
   - 本番環境ではHttpOnly Cookie使用

4. **その他の対策**:
   - ブルートフォース対策（ログイン試行回数制限）
   - APIレスポンスの機微情報フィルタリング
   - デバッグ情報の本番環境での非表示

## パフォーマンス最適化

アプリケーションのパフォーマンスを最適化するため、以下の戦略を採用しています：

1. **コードスプリッティング**: React.lazyとSuspenseを使用した遅延ローディング
2. **メモ化**: React.memo, useMemo, useCallbackによる不要な再レンダリング防止
3. **キャッシング**: React Queryによるサーバーデータのキャッシング
4. **デバウンス**: 入力フォームでのデバウンス適用によるAPI呼び出し最適化

## テスト戦略

アプリケーションは以下の複数レベルでテストされます：

1. **ユニットテスト**: 個別の関数とコンポーネントのテスト
2. **インテグレーションテスト**: 複数コンポーネントの連携テスト
3. **E2Eテスト**: 実際のユーザーフローをシミュレートするCypressテスト

認証関連テストでは、以下の戦略を採用しています：

- トークンストレージのモック化
- 認証APIのモック化
- 保護されたルートの適切なリダイレクトテスト

## 依存関係

主要な依存関係は以下の通りです：

- **React**: UIライブラリ
- **TypeScript**: 型安全なコーディング
- **React Router**: ルーティング
- **Axios**: HTTP通信
- **React Query**: サーバー状態管理
- **JWT Decode**: JWTトークンのデコード
- **zod**: 入力検証

## 拡張性

このアーキテクチャは、以下の方法で拡張可能です：

1. **追加認証プロバイダー**: 新しいソーシャルログインプロバイダーの追加
2. **多要素認証**: 2FAなどの追加認証レイヤーの実装
3. **権限ベースのアクセス制御**: 既存の認証システムに権限管理を追加
4. **マルチテナント対応**: 組織やチームベースの認証拡張

## デプロイアーキテクチャ

推奨デプロイアーキテクチャは以下の通りです：

```
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
| CDN            +---->+ Static Hosting +---->+ API Backend   |
| (CloudFront)   |     | (S3/Netlify)   |     | (Express/Node) |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
                                                      |
                                                      v
                                              +-------+--------+
                                              |                |
                                              | Database       |
                                              | (MongoDB/PG)   |
                                              |                |
                                              +----------------+
```

## コード規約とスタイルガイド

このプロジェクトでは、以下のコード規約とスタイルガイドを採用しています：

1. **TypeScriptコーディング規約**: strict modeを有効化し、明示的な型定義を推奨
2. **コンポーネント構造**: 機能単位でのディレクトリ構成とindex.tsによるエクスポート
3. **命名規則**: PascalCaseのコンポーネント名、camelCaseの関数名とプロパティ名
4. **CSS規則**: CSSモジュールでのスコープ付きスタイル定義

## 結論

このアーキテクチャは、セキュリティと拡張性を重視したモダンなReactアプリケーションの構築を目的としています。認証フローは業界のベストプラクティスに従い、将来的な機能拡張にも対応できるよう設計されています。
