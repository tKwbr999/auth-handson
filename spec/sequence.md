# 認証システムのシーケンス図

このドキュメントでは、React Authentication Sample Appの主要な認証フローをシーケンス図で解説します。シーケンス図はアプリケーションのコンポーネント間の相互作用を時系列で表現し、認証プロセスの理解を助けます。

## 目次

1. [ユーザーログインフロー](#ユーザーログインフロー)
2. [トークン自動更新フロー](#トークン自動更新フロー)
3. [保護されたルートアクセスフロー](#保護されたルートアクセスフロー)
4. [ユーザー登録フロー](#ユーザー登録フロー)
5. [パスワードリセットフロー](#パスワードリセットフロー)
6. [ソーシャルログインフロー](#ソーシャルログインフロー)
7. [ログアウトフロー](#ログアウトフロー)

**注意**: このドキュメントのシーケンス図はテキストベースで作成されています。実際の実装では、PlantUML、Mermaid.jsなどのツールを使用して視覚的に分かりやすいダイアグラムを生成することをお勧めします。

## ユーザーログインフロー

このシーケンスは、ユーザーがメールアドレスとパスワードを使ってログインする基本的なフローを示しています。

```
+------------+    +-------------+    +------------+    +-------------+    +----------+
| LoginPage  |    | AuthContext |    | authApi    |    | tokenStorage|    | Backend  |
+------------+    +-------------+    +------------+    +-------------+    +----------+
      |                  |                 |                  |                |
      | submit login form|                 |                  |                |
      |----------------->|                 |                  |                |
      |                  | login(email, pw)|                  |                |
      |                  |---------------->|                  |                |
      |                  |                 | POST /auth/login |                |
      |                  |                 |---------------------------------->|
      |                  |                 |                  |                |
      |                  |                 |                  |    validate    |
      |                  |                 |                  |    credentials |
      |                  |                 |                  |<---------------|
      |                  |                 |                  |                |
      |                  |                 |      200 OK (tokens, user data)   |
      |                  |                 |<----------------------------------|
      |                  |                 |                  |                |
      |                  |                 | setToken(tokens) |                |
      |                  |                 |----------------->|                |
      |                  |                 |                  | store tokens   |
      |                  |                 |                  |----------------|
      |                  |                 |                  |                |
      |                  | login success   |                  |                |
      |                  |<----------------|                  |                |
      |                  |                 |                  |                |
      | update UI        |                 |                  |                |
      |<-----------------|                 |                  |                |
      |                  |                 |                  |                |
      | redirect to      |                 |                  |                |
      | dashboard        |                 |                  |                |
      |------------------|                 |                  |                |
      |                  |                 |                  |                |
```

## トークン自動更新フロー

このシーケンスは、アクセストークンの有効期限が切れた場合に自動的にトークンを更新するフローを示しています。

```
+--------------+    +------------+    +-------------+    +----------+
| ApiInterceptor|    | authApi    |    | tokenStorage|    | Backend  |
+--------------+    +------------+    +-------------+    +----------+
        |                 |                  |                |
        | API request     |                  |                |
        |---------------->|                  |                |
        |                 | GET /some-endpoint                |
        |                 |---------------------------------->|
        |                 |                  |                |
        |                 |     401 Unauthorized              |
        |                 |<----------------------------------|
        |                 |                  |                |
        |                 | getRefreshToken()|                |
        |                 |----------------->|                |
        |                 |                  |                |
        |                 | refreshToken     |                |
        |                 |<-----------------|                |
        |                 |                  |                |
        |                 | POST /auth/refresh                |
        |                 |---------------------------------->|
        |                 |                  |                |
        |                 |                  |  validate refresh token |
        |                 |                  |<---------------|
        |                 |                  |                |
        |                 |   200 OK (new tokens)             |
        |                 |<----------------------------------|
        |                 |                  |                |
        |                 | setToken(tokens) |                |
        |                 |----------------->|                |
        |                 |                  | store tokens   |
        |                 |                  |----------------|
        |                 |                  |                |
        |                 | retry original request            |
        |                 |---------------------------------->|
        |                 |                  |                |
        |                 |      200 OK (data)                |
        |                 |<----------------------------------|
        | return data     |                  |                |
        |<----------------|                  |                |
        |                 |                  |                |
```

## 保護されたルートアクセスフロー

このシーケンスは、認証が必要なルートにアクセスする際のフローを示しています。

```
+------------+    +-------------+    +----------------+    +-------------+
| Router     |    | ProtectedRoute |    | AuthContext |    | tokenStorage|
+------------+    +-------------+    +----------------+    +-------------+
      |                  |                    |                   |
      | navigate to      |                    |                   |
      | protected route  |                    |                   |
      |----------------->|                    |                   |
      |                  | isAuthenticated?   |                   |
      |                  |------------------->|                   |
      |                  |                    | getToken()        |
      |                  |                    |------------------>|
      |                  |                    |                   |
      |                  |                    | token or null     |
      |                  |                    |<------------------|
      |                  |                    |                   |
      |                  | auth status        |                   |
      |                  |<-------------------|                   |
      |                  |                    |                   |
      |                  | if not authenticated                   |
      |                  |----------------    |                   |
      |                  |               |    |                   |
      |                  |<---------------    |                   |
      |                  |                    |                   |
      |                  | redirect to login  |                   |
      |<-----------------|                    |                   |
      |                  |                    |                   |
      | if authenticated |                    |                   |
      | render component |                    |                   |
      |<-----------------|                    |                   |
      |                  |                    |                   |
```

## ユーザー登録フロー

このシーケンスは、新規ユーザーが登録する際のフローを示しています。

```
+-------------+    +-------------+    +------------+    +-------------+    +----------+
| RegisterPage |    | AuthContext |    | authApi    |    | tokenStorage|    | Backend  |
+-------------+    +-------------+    +------------+    +-------------+    +----------+
       |                  |                 |                  |                |
       | submit           |                 |                  |                |
       | registration form|                 |                  |                |
       |----------------->|                 |                  |                |
       |                  | register(userData)                 |                |
       |                  |---------------->|                  |                |
       |                  |                 | validate input   |                |
       |                  |                 |------------------|                |
       |                  |                 |                  |                |
       |                  |                 | POST /auth/register              |
       |                  |                 |--------------------------------->|
       |                  |                 |                  |                |
       |                  |                 |                  |  create user   |
       |                  |                 |                  |<---------------|
       |                  |                 |                  |                |
       |                  |                 |    201 Created (user data)        |
       |                  |                 |<---------------------------------|
       |                  |                 |                  |                |
       |                  | registration    |                  |                |
       |                  | success         |                  |                |
       |                  |<----------------|                  |                |
       |                  |                 |                  |                |
       | update UI        |                 |                  |                |
       |<-----------------|                 |                  |                |
       |                  |                 |                  |                |
       | redirect to      |                 |                  |                |
       | login page       |                 |                  |                |
       |------------------|                 |                  |                |
       |                  |                 |                  |                |